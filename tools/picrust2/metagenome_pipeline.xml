<tool id="picrust2_metagenome_pipeline" name="PICRUSt2 Metagenome prediction" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>to generate per-sample metagenome functional profiles based on the predicted functions for each study sequence</description>
    <expand macro="bio_tool"/>    
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <version_command>metagenome_pipeline.py -v</version_command>
    <command detect_errors="exit_code"><![CDATA[
#if $input.datatype.file_ext == "mothur.shared"
    #set ext="msf"
#else if $input.datatype.file_ext == "tabular"
    #set ext="tsv"
#else if $input.ext == 'biom2'
    #set ext="biom"
#else if $input.ext == 'biom1'
    #set ext="biom"
#else
    >&2 "unknown extension $input.ext"
    exit 1;
#end if
#if $input.ext.endswith(".gz")
    #set ext+=".gz"
#end if
ln -s '$input' 'input.$ext' &&
metagenome_pipeline.py
    --input 'input.$ext'
    --function '$function'
#if $marker    
    --marker '$marker'
#end if
#if $input_options.selector == "ASV"
    --min_reads $input_options.min_reads
    --min_samples $input_options.min_samples
#end if
#if $stratified_output.selector == 'yes'
    $stratified_output.strat_out
    $stratified_output.wide_table
#end if    
    $skip_norm
    --max_nsti $max_nsti
    --out_dir 'metagenome_output'
&&
cd ./metagenome_output
&&
gunzip *tsv.gz
&& ls .
    ]]></command>
    <inputs>
        <param argument="--input" type="data" format="tabular,biom1,biom2,mothur.shared" label="Sequence abundance table(OTUs or ASVs)" help="The sequence abundances should be in read counts and not relative abundances. The tool will normalize the input sequence abundance table by the predicted number of marker genes."/>
        <conditional name="input_options">
            <param name="selector" type="select" label="Sequence abundance table type">
                <option value="OTU" selected="true">Operational Taxonomic Units (OTU)</option>
                <option value="ASV">Amplicon Sequence Variants (ASV)</option>
            </param>
            <when value="OTU">
            </when>
            <when value="ASV">
                <param argument="--min_reads" type="integer" value="1" label="Minimum number of reads across all samples for each input ASV." help="ASVs below this cut-off will be counted as part of the RARE category in the stratified output"/>
                <param argument="--min_samples" type="integer" value="1" label="Minimum number of samples that an ASV needs to be identfied within" help="ASVs below this cut-off will be counted as part of the RARE category in the stratified output"/>
            </when>
        </conditional>
        <param argument="--function" type="data" format="tabular" label="Table with predicted gene family copy numbers" help="This table is generated by the tool for Hidden state prediction (HSP)"/>
        <param argument="--marker" type="data" format="tabular" label="Table of predicted marker gene (16S or other) copy numbers" help="This table is generated by the tool for Hidden state prediction (HSP)"/>
        <param argument="--max_nsti" type="float" value="2.0" label="Sequences with Nearest-sequenced taxon index (NSTI) values above this value will be excluded"/>
        <conditional name="stratified_output">
            <param name="selector" type="select" label="Generate an output table stratified by sequences?">
                <option value="no" selected="true">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="yes">
                <param argument="--strat_out" type="boolean" truevalue="--strat_out" falsevalue="" checked="true" label="Generate an output table stratified by sequences?"/> 
                <param argument="--wide_table" type="boolean" truevalue="--wide_table" falsevalue="" checked="false" label="Output wide-format stratified table of metagenome predictions" help="This is the deprecated method of generating stratified tables since it is extremely memory intensive"/> 
            </when>
            <when value="no">
                <param argument="--strat_out" type="boolean" truevalue="--strat_out" falsevalue="" checked="false" label="Generate an output table stratified by sequences?"/> 
            </when>            
        </conditional>      
        <param argument="--skip_norm" type="boolean" truevalue="--skip_norm" falsevalue="" checked="false" label="Skip normalizing sequence abundances by predicted marker gene copy numbers"/> 
    </inputs>
    <outputs>
        <data name="pred_metagenome_unstrat" format="tabular" from_work_dir="metagenome_output/pred_metagenome_unstrat.tsv" label="${tool.name} on ${on_string}:Predicted per-sample metagenome functional profiles">
        </data>
        <data name="seqtab_norm" format="tabular" from_work_dir="metagenome_output/seqtab_norm.tsv" label="${tool.name} on ${on_string}:Normalized sequence abundance table">
        </data>
        <data name="weighted_nsti" format="tabular" from_work_dir="metagenome_output/weighted_nsti.tsv" label="${tool.name} on ${on_string}:Weighted nearest-sequenced taxon index (NSTI) values per-sample">
        </data>
        <data format="tabular" name="strat_output" from_work_dir="metagenome_output/pred_metagenome_contrib.tsv" label="${tool.name} on ${on_string}:Predicted per-sample metagenome functional profiles, stratified by sequence ids (i.e. taxonomic contributors)" >
            <filter>stratified_output['strat_out'] is True and stratified_output['wide_table'] is False</filter>
        </data>
        <data format="tabular" name="wide_table_output" from_work_dir="metagenome_output/pred_metagenome_strat.tsv" label="${tool.name} on ${on_string}:Predicted per-sample metagenome functional profiles, wide-format stratified by sequence ids (i.e. taxonomic contributors)" >
            <filter>stratified_output['strat_out'] is True and stratified_output['wide_table'] is True</filter>
        </data>        
    </outputs>
    <tests>
    <test expect_num_outputs="3">
        <param name="input" ftype="mothur.shared" value="table.mothur.shared"/>
        <param name="function" ftype="tabular" value="EC_predicted.tsv.gz"/>
        <param name="marker" ftype="tabular" value="16S_predicted_and_nsti.tsv.gz"/>
        <param name="max_nsti" value="2.0"/>
        <param name="skip_norm" value="false"/>
        <conditional name="stratified_output">
            <param name="selector" value="no"/>
        </conditional>
        <conditional name="input_options">
            <param name="selector" value="OTU"/>
        </conditional>
        <output name="pred_metagenome_unstrat" ftype="tabular">
            <assert_contents>
                <has_text text="function"/>
                <has_n_lines n="1000"/>
            </assert_contents>
        </output>
        <output name="seqtab_norm" ftype="tabular">
            <assert_contents>
                <has_text text="normalized"/>
                <has_n_lines n="38"/>
            </assert_contents>
        </output>
        <output name="weighted_nsti" ftype="tabular">
            <assert_contents>
                <has_text text="weighted_NSTI"/>
                <has_n_lines n="25"/>
            </assert_contents>
        </output>
    </test>
    <test expect_num_outputs="3">
        <param name="input" ftype="biom1" value="table.biom"/>
        <param name="function" ftype="tabular" value="EC_predicted.tsv.gz"/>
        <param name="marker" ftype="tabular" value="16S_predicted_and_nsti.tsv.gz"/>
        <param name="max_nsti" value="2.0"/>
        <param name="skip_norm" value="false"/>
        <conditional name="stratified_output">
            <param name="selector" value="no"/>
        </conditional>
        <conditional name="input_options">
            <param name="selector" value="ASV"/>
            <param name="min_reads" value="1"/>
            <param name="min_samples" value="1"/>
        </conditional>
        <output name="pred_metagenome_unstrat" ftype="tabular">
            <assert_contents>
                <has_text text="function"/>
                <has_n_lines n="1000"/>
            </assert_contents>
        </output>
        <output name="seqtab_norm" ftype="tabular">
            <assert_contents>
                <has_text text="normalized"/>
                <has_n_lines n="38"/>
            </assert_contents>
        </output>
        <output name="weighted_nsti" ftype="tabular">
            <assert_contents>
                <has_text text="weighted_NSTI"/>
                <has_n_lines n="25"/>
            </assert_contents>
        </output>
    </test>
    <test expect_num_outputs="4">
        <param name="input" ftype="biom1" value="table.biom"/>
        <param name="function" ftype="tabular" value="EC_predicted.tsv.gz"/>
        <param name="marker" ftype="tabular" value="16S_predicted_and_nsti.tsv.gz"/>
        <param name="max_nsti" value="2.0"/>
        <param name="skip_norm" value="false"/>
        <conditional name="stratified_output">
            <param name="selector" value="yes"/>
            <param name="strat_out" value="true"/>
            <param name="wide_table" value="true"/>
        </conditional>
        <conditional name="input_options">
            <param name="selector" value="ASV"/>
            <param name="min_reads" value="1"/>
            <param name="min_samples" value="1"/>
        </conditional>
        <output name="pred_metagenome_unstrat" ftype="tabular">
            <assert_contents>
                <has_text text="function"/>
                <has_n_lines n="1000"/>
            </assert_contents>
        </output>
        <output name="seqtab_norm" ftype="tabular">
            <assert_contents>
                <has_text text="normalized"/>
                <has_n_lines n="38"/>
            </assert_contents>
        </output>
        <output name="weighted_nsti" ftype="tabular">
            <assert_contents>
                <has_text text="weighted_NSTI"/>
                <has_n_lines n="25"/>
            </assert_contents>
        </output>
        <output name="wide_table_output" ftype="tabular">
            <assert_contents>
                <has_text text="EC:1.1.1.1"/>
                <has_n_lines n="18101"/>
            </assert_contents>
        </output>
    </test>
    <test expect_num_outputs="4">
        <param name="input" ftype="biom1" value="table.biom"/>
        <param name="function" ftype="tabular" value="EC_predicted.tsv.gz"/>
        <param name="marker" ftype="tabular" value="16S_predicted_and_nsti.tsv.gz"/>
        <param name="max_nsti" value="2.0"/>
        <param name="skip_norm" value="false"/>
        <conditional name="stratified_output">
            <param name="selector" value="yes"/>
            <param name="strat_out" value="true"/>
            <param name="wide_table" value="false"/>
        </conditional>
        <conditional name="input_options">
            <param name="selector" value="ASV"/>
            <param name="min_reads" value="1"/>
            <param name="min_samples" value="1"/>
        </conditional>
        <output name="pred_metagenome_unstrat" ftype="tabular">
            <assert_contents>
                <has_text text="function"/>
                <has_n_lines n="1000"/>
            </assert_contents>
        </output>
        <output name="seqtab_norm" ftype="tabular">
            <assert_contents>
                <has_text text="normalized"/>
                <has_n_lines n="38"/>
            </assert_contents>
        </output>
        <output name="weighted_nsti" ftype="tabular">
            <assert_contents>
                <has_text text="weighted_NSTI"/>
                <has_n_lines n="25"/>
            </assert_contents>
        </output>
        <output name="strat_output" ftype="tabular">
            <assert_contents>
                <has_text text="100CHE6KO"/>
                <has_n_lines n="298016"/>
            </assert_contents>
        </output>
    </test>
    </tests>
    <help><![CDATA[
@HELP_HEADER@

Metagenome Pipeline
===================
Reads in a sequence abundance table (the abundances of OTUs or ASVs in BIOM, TSV, or mothur shared file format), the predicted marker gene abundances, and the predicted gene family abundances (these last two files are output by hsp.py). 

Note
====
Per-sample metagenome functional profiles are generated based on the predicted functions for each study sequence. Note that typically these sequences correspond to OTUs or ASVs. The specified sequence abundance table will be normalized by the predicted number of marker gene copies before outputting the final files by default. The sample metagenome table stratified by contributing ASVs can optionally also be output.

The sequence abundances should be in read counts and not relative abundances. It will normalize the input sequence abundance table by the predicted number of marker genes. It will then determine the predicted functional profiles per sample. Output stratified by sequence ids (i.e. taxonomic contributors) will also be output if the --strat_out option is used. Also, rare ASVs can be collapsed into the same category in the stratified output table based on the --min_reads and --min_samples options. Note the output files are tab-delimited even if the input files was in BIOM format. The normalized sequence abundance table and the weighted nearest-sequenced taxon index values per-sample will also be output to the output directory as separate files.

Input
=====
Table of sequence abundances (BIOM, TSV, or mothur shared file format).

Output
======
Metagenome predictions:
  1. Predicted per-sample metagenome functional profiles
  2. Normalized sequence abundance table
  3. Weighted nearest-sequenced taxon index (NSTI) values per-sample
  4. When chosen within the tool's parameters: Predicted per-sample metagenome functional profiles, stratified by sequence ids (i.e. taxonomic contributors)
  5. When chosen within the tool's parameters: Predicted per-sample metagenome functional profiles, wide-format stratified by sequence ids (i.e. taxonomic contributors)

    ]]></help> 
    <citations>
        <citation type="doi">10.1038/s41587-020-0548-6</citation>
    </citations>
</tool>