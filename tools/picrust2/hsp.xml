<tool id="picrust2_hsp" name="Picrust2 HSP" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Hidden state prediction for 16S copy, EC numbers, and KO abundances per-genome</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="edam_ontology"/>
    <expand macro="requirements"/>
    <version_command>hsp.py -v</version_command>
    <command detect_errors="exit_code"><![CDATA[
hsp.py
    --tree '$tree'
    --in_trait '$in_trait'    
    --output 'prediction_output.tsv'
    --hsp_method '$hsp_method'
    --edge_exponent '$edge_exponent'
    --chunk_size '$chunk_size'
    --seed '$seed'
    $calculate_NSTI
    $check
    -p "\${GALAXY_SLOTS:-1}"
    ]]></command>
    <inputs>
        <param argument="--tree" type="data" format="newick" label="The full reference tree in newick format" help="Contains both study sequences (i.e. ASVs or OTUs) and reference sequences."/>
        <param argument="--in_trait" type="select" label="Select which default count table to use" help="one of '16S', 'COG', 'EC', 'KO', 'PFAM', 'TIGRFAM', 'PHENO')">
            <option value="16S">16S</option>
            <option value="COG">COG</option>
            <option value="EC">EC</option>
            <option value="KO">KO</option>
            <option value="PFAM">PFAM</option>
            <option value="TIGRFAM">TIGRFAM</option>
            <option value="PHENO">PHENO</option>
        </param>
        <param argument="--hsp_method" type="select" label="Select which hidden-state prediction method to use" help="which needs to be one of: maximum parsimony (mp), empirical probabilities (emp_prob), subtree averaging (subtree_average), phylogenetic independent contrast (pic), or squared-change parsimony (scp)">
            <option value="mp" selected="true">mp</option>
            <option value="emp_prob">emp_prob</option>
            <option value="subtree_average">subtree_average</option>
            <option value="pic">pic</option>
            <option value="scp">scp</option>
        </param>
        <param argument="--edge_exponent" type="integer" value="0" min="0" optional="true" label="Setting for maximum parisomony hidden-state prediction" help="Specifies weighting transition costs by the inverse length of edge lengths. If 0, then edge lengths do not influence predictions. Must be a non-negative real-valued number (default: 0.5)"/>
        <param argument="--seed" type="integer" value="100" optional="true" label="Seed to make output reproducible" help="is necessary for the emp_prob method"/>       
        <param argument="--chunk_size" type="integer" value="500" optional="true" label="Number of functions to run at a time on one processor" help="Note that you should consider how many processes you have specified before changing this option. E.g. if you specify the chunk_size to be the total number of functions, 1 processor will be used even if you specified more so the job will be substantially slower"/>
        <param argument="calculate_NSTI" type="boolean" truevalue="-n" falsevalue='' checked="false" label="Calculate NSTI and add to output file"/> 
        <param argument="check" type="boolean" truevalue="--check" falsevalue='' checked="false" label="Check input trait table before HSP"/> 
    </inputs>
    <outputs>
        <data name="prediction_output" format="tsv" from_work_dir="prediction_output.tsv" label="Output for the Hidden State Prediction">
        </data>
    </outputs>
    <tests>
    <test expect_num_outputs="1">
        <param name="tree" ftype="newick" value="out_tree.tre"/>
        <param name="in_trait" value="16S"/>
        <param name="hsp_method" value="mp"/>
        <param name="edge_exponent" value="0"/>
        <param name="seed" value="100"/>
        <param name="chunk_size" value="500"/>
        <param name="calculate_NSTI" value="false"/>
        <param name="check" value="false"/>
        <output name="prediction_output" ftype="tsv">
            <assert_contents>
                <has_text text="sequence"/>
                <has_n_lines n="38"/>
            </assert_contents>
        </output>
    </test>
    </tests>
    <help><![CDATA[
@HELP_HEADER@

Hidden State Prediction (HSP)
=============================
Performs hidden state prediction on tips in the input tree with unknown trait values. Typically this script is used to predict the copy number of gene families present in the predicted genome for each amplicon sequence variant, given a tree and a set of known trait values. This script outputs a table of trait predictions.

Note
====
Run hidden-state prediction (hsp) to predict gene family abundances.

Input
=====
Newick tree with study sequences placed amongst reference sequences.

Output
======
Tabular file containing predicted counts.

    ]]></help> 
    <citations>
        <citation type="doi">10.1038/s41587-020-0548-6</citation>
    </citations>
</tool>