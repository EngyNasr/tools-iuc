<tool id="picrust2_hsp" name="PICRUSt2 - Hidden state prediction (HSP)" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>to predict gene family abundances</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <version_command>hsp.py -v</version_command>
    <command detect_errors="exit_code"><![CDATA[
hsp.py
    --tree '$tree'
#if $trait_input.selector == "default"
    --in_trait '$trait_input.in_trait'
#else if $trait_input.selector == "custom"
    --observed_trait_table '$trait_input.observed_trait_table'
#end if
    --hsp_method '$hsp_method__options.hsp_method'
#if $hsp_method__options.hsp_method == "mp"
    --edge_exponent $hsp_method__options.edge_exponent
#else if $hsp_method__options.hsp_method == "emp_prob"
    --seed $hsp_method__options.seed
#end if
    --output '$prediction_output'
    $n
    $check
    $chunk_size
    -p "\${GALAXY_SLOTS:-1}"
    ]]></command>
    <inputs>
        <param argument="--tree" type="data" format="newick" label="Newick tree with study sequences placed amongst reference sequences" help="The full reference tree containing both study sequences (i.e. ASVs or OTUs) and reference sequences."/>
        <conditional name="trait_input">
            <param name="selector" type="select" label="Argument specifying non-default reference files to use for sequence placement">
                <option value="default" selected="true">Default trait table</option>
                <option value="custom">Customized trait table</option>
            </param>
            <when value="default">
                <param argument="--in_trait" type="select" label="Default pre-calculated count table to use">
                    <option value="16S">16S</option>
                    <option value="COG">COG</option>
                    <option value="EC">EC</option>
                    <option value="KO">KO</option>
                    <option value="PFAM">PFAM</option>
                    <option value="TIGRFAM">TIGRFAM</option>
                    <option value="PHENO">PHENO</option>
                </param>
            </when>
            <when value="custom">
                <param argument="--observed_trait_table" type="data" format="tabular" label="Customized trait table" help="Describes directly observed traits (e.g. sequenced genomes) in tab-delimited format. "/>
            </when>
        </conditional>
        <conditional name="hsp_method__options">
            <param argument="--hsp_method" type="select" label="Hidden-state prediction method to use">
                <option value="mp" selected="true">Predict discrete traits by: Maximum parsimony (mp)</option>
                <option value="emp_prob">Predict discrete traits by: Empirical state probabilities across tips (emp_prob)</option>
                <option value="subtree_average">Predict continuous traits by: Subtree averaging (subtree_average)</option>
                <option value="pic">Predict continuous traits by: phylogentic independent contrast (pic)</option>
                <option value="scp">Reconstruct continuous traits by: squared-change parsimony (scp)</option>
            </param>
            <when value="mp">
                <param argument="--edge_exponent" type="float" value="0.5" min="0.0" label="Setting for maximum parisimony hidden-state prediction" help="Specifies weighting transition costs by the inverse length of edge lengths. If 0, then edge lengths do not influence predictions"/>
            </when>
            <when value="emp_prob">
                <param argument="--seed" type="integer" value="100" label="Seed to make output reproducible" help="is necessary for the emp_prob method"/>
            </when>
        </conditional>
        <param argument="-n" type="boolean" truevalue="-n" falsevalue="" checked="false" label="Calculate NSTI and add to output file" help="Indicates that Nearest-sequenced taxon index (NSTI) values should be calculated"/>
        <param argument="--check" type="boolean" truevalue="--check" falsevalue="" checked="false" label="Check input trait table before HSP"/>
        <param argument="--chunk_size" type="integer" optional="true" label="Number of functions to run at a time on one processor"/>    
    </inputs>
    <outputs>
        <data name="prediction_output" format="tabular"/>
    </outputs>
    <tests>
    <test expect_num_outputs="1">
        <param name="tree" ftype="newick" value="out_tree.zip"/>
        <param name="n" value="false"/>
        <param name="check" value="false"/>
        <conditional name="trait_input">
            <param name="selector" value="default"/>
            <param name="in_trait" value="16S"/>
        </conditional>
        <conditional name="hsp_method__options">
            <param name="hsp_method" value="mp"/>
            <param name="edge_exponent" value="0.0"/>
        </conditional>
        <output name="prediction_output" ftype="tabular">
            <assert_contents>
                <has_text text="sequence"/>
                <has_n_lines n="38"/>
            </assert_contents>
        </output>
    </test>
    <test expect_num_outputs="1">
        <param name="tree" ftype="newick" value="out_tree.zip"/>
        <param name="n" value="false"/>
        <param name="check" value="false"/>
        <conditional name="trait_input">
            <param name="selector" value="custom"/>
            <param name="observed_trait_table" value="known_traits.tsv.gz"/>
        </conditional>
        <conditional name="hsp_method__options">
            <param name="hsp_method" value="mp"/>
            <param name="edge_exponent" value="0.0"/>
        </conditional>
        <output name="prediction_output">
            <assert_contents>
                <has_text text="2040502012"/>
                <has_n_lines n="20005"/>
            </assert_contents>
        </output>
    </test>
    <test expect_num_outputs="1">
        <param name="tree" ftype="newick" value="out_tree.zip"/>
        <param name="n" value="false"/>
        <param name="check" value="false"/>
        <conditional name="trait_input">
            <param name="selector" value="default"/>
            <param name="in_trait" value="16S"/>
        </conditional>
        <conditional name="hsp_method__options">
            <param name="hsp_method" value="emp_prob"/>
            <param name="seed" value="100"/>
        </conditional>
        <output name="prediction_output">
            <assert_contents>
                <has_text text="sequence"/>
                <has_n_lines n="38"/>
            </assert_contents>
        </output>
    </test>
    </tests>
    <help><![CDATA[
@HELP_HEADER@

Hidden State Prediction (HSP)
=============================
Performs hidden state prediction on tips in the input tree with unknown trait values. Typically this script is used to predict the copy number of gene families present in the predicted genome for each amplicon sequence variant, given a tree and a set of known trait values. This script outputs a table of trait predictions.

Note
====
Run hidden-state prediction (hsp) to predict gene family abundances.

Input
=====
Newick tree with study sequences placed amongst reference sequences.

Output
======
Tabular file containing predicted counts.

    ]]></help> 
    <citations>
        <citation type="doi">10.1038/s41587-020-0548-6</citation>
    </citations>
</tool>