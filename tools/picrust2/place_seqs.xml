<tool id="picrust2_place_seqs" name="Picrust2 Place Seqs" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Place reads into reference tree</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="edam_ontology"/>
    <expand macro="requirements"/>
    <version_command>place_seqs.py -v</version_command>
    <command detect_errors="exit_code"><![CDATA[
#if $ref_dir.selector == "fungi"
    mkdir -p fungi/
    &&
    ln -s '$ref_dir.fungi_fna' fungi/fungi.fna
    &&
    ln -s '$ref_dir.fungi_hmm' fungi/fungi.hmm
    &&
#if $placement_tool == "epa-ng"
    ln -s '$ref_dir.fungi_model' fungi/fungi.model
#else if $placement_tool == "sepp"
    ln -s '$ref_dir.fungi_model' fungi/fungi.raxml_info
#end if
    &&
    ln -s '$ref_dir.fungi_tre' fungi/fungi.tre
    &&
#end if    
#if $ref_dir.selector == "custom"
    mkdir -p custom/
    &&
    ln -s '$ref_dir.custom_fna' custom/custom.fna
    &&
    ln -s '$ref_dir.custom_hmm' custom/custom.hmm
    &&
#if $placement_tool == "epa-ng"
    ln -s '$ref_dir.custom_model' custom/custom.model
#else if $placement_tool == "sepp"
    ln -s '$ref_dir.custom_model' custom/custom.raxml_info
#end if
    &&
    ln -s '$ref_dir.custom_tre' custom/custom.tre
    &&
#end if
#if $intermediate_check
    mkdir -p intermediate/place_seqs
    &&
#end if
place_seqs.py
    --study_fasta '$study_fasta'
    --placement_tool '$placement_tool'
#if $ref_dir.selector == "custom"
    --ref_dir custom
#else if $ref_dir.selector == "fungi"
    --ref_dir fungi
#end if
    --out_tree 'out_tree.tre'
    --processes "\${GALAXY_SLOTS:-1}"
#if $intermediate_check
    --intermediate 'intermediate_out'
#end if
    --min_align $min_align
#if $chunk_size    
    --chunk_size $chunk_size
#end if    
#if $intermediate_check
&& zip -r intermediate_out.zip intermediate_out/
#end if    
    ]]></command>
    <inputs>
        <param argument="--study_fasta" type="data" format="fasta" label="FASTA of unaligned study sequences"/>
        <param argument="--placement_tool" type="select" label="Placement tool to use when placing sequences into reference tree">
            <option value="epa-ng" selected="true">epa-ng</option>
            <option value="sepp">sepp</option>
        </param>
        <conditional name="ref_dir">
            <param name="selector" type="select" label="Argument specifying non-default reference files to use for sequence placement">
                <option value="prokaryotic" selected="true">Default directory containing reference sequence files of prokaryotic 16S rRNA gene alignment</option>
                <option value="fungi">Direct to the fungal ITS files</option>
                <option value="custom">Custom reference sequence files</option>
            </param>
            <when value="prokaryotic">
            </when>
            <when value="fungi">
                <param name="fungi_fna" type="data" format="fasta" label="Fasta file for the reference database of the sequesnces"/>
                <param name="fungi_hmm" type="data" format="hmm2,hmm3" label="HMM file for the reference database of the sequesnces"/>
                <param name="fungi_model" type="data" format="txt" label="Model file for the reference database of the sequesnces"/>
                <param name="fungi_tre" type="data" format="newick" label="Tree file for the reference database of the sequesnces"/>
            </when>
            <when value="custom">
                <param name="custom_fna" type="data" format="fasta" label="Fasta file for the reference database of the sequesnces"/>
                <param name="custom_hmm" type="data" format="hmm2,hmm3" label="HMM file for the reference database of the sequesnces"/>
                <param name="custom_model" type="data" format="txt" label="Model file for the reference database of the sequesnces"/>
                <param name="custom_tre" type="data" format="newick" label="Tree file for the reference database of the sequesnces"/>
            </when>
        </conditional>
        <param argument="--intermediate_check" type="boolean" truevalue="intermediate_check" falsevalue="" checked="false" label="Output folder for intermediate files" help="Intermediate output files will be deleted by default"/>
        <param argument="--min_align" type="float" value="0.80" label="Proportion of the total length of an input query sequence that must align with reference sequences" help="Any sequences with lengths below this value after making an alignment with reference sequences will be excluded from the placement and all subsequent steps."/>
        <param argument="--chunk_size" type="integer" value="5000" optional="true" label="Number of query seqs to read in at once for EPA-ng"/>
   </inputs>
   <outputs>
        <data name="out_tree" format="newick" from_work_dir="out_tree.tre" label="Output Tree with Sequences">
        </data>
        <data format="zip" name="intermediate_output_files" from_work_dir="intermediate_out.zip" label="Intermediate files/folders (Zip)" >
            <filter>intermediate_check is True</filter>
        </data>               
    </outputs>
    <tests>
    <test expect_num_outputs="2">
        <param name="study_fasta" ftype="fasta" value="study_seqs_test.fasta"/>
        <param name="placement_tool" value="sepp"/>
        <param name="intermediate_check" value="true"/>
        <param name="min_align" value="0.80"/>
        <param name="chunk_size" value="5000"/>
        <param name="verbose" value="false"/>
        <conditional name="ref_dir">
            <param name="selector" value="prokaryotic"/>
        </conditional>
        <output name="out_tree" ftype="newick">
            <assert_contents>
                <has_n_lines n="1"/>
            </assert_contents>
        </output>
        <output name="intermediate_output_files" ftype="zip">
            <assert_contents>
                <has_size value="12582912" delta="1000000"/>
            </assert_contents>
        </output>
    </test>
    </tests>
    
    <help><![CDATA[
@HELP_HEADER@

Place Seqs (Sequence placement)
===============================
Script to run EPA-ng and GAPPA to place study sequences (i.e. OTUs or ASVs) into a reference tree. 

Note
====
This is typically done to prep for subsequent hidden-state prediction with PICRUSt2. Requires unaligned FASTA of study sequences. Users can specify a non-default reference files if needed.

Input
=====
The study sequences (i.e. FASTA of amplicon sequence variants or operational taxonomic units)

Output
======
Output tree with placed study sequences.

    ]]></help> 
    <citations>
        <citation type="doi">10.1038/s41587-020-0548-6</citation>
    </citations>
 </tool>