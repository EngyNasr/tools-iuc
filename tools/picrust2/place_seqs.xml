<tool id="picrust2_place_seqs" name="PICRUSt2 Sequence placement" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>into reference tree</description>
    <expand macro="bio_tool"/>    
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <version_command>place_seqs.py -v</version_command>
    <command detect_errors="exit_code"><![CDATA[
#if $ref_dir.selector == "fungi"
    mkdir -p fungi/
    &&
    ln -s '$ref_dir.fungi_fna' fungi/fungi.fna
    &&
    ln -s '$ref_dir.fungi_hmm' fungi/fungi.hmm
    &&
#if $placement_tool == "epa-ng"
    ln -s '$ref_dir.fungi_model' fungi/fungi.model
#else if $placement_tool == "sepp"
    ln -s '$ref_dir.fungi_model' fungi/fungi.raxml_info
#end if
    &&
    ln -s '$ref_dir.fungi_tre' fungi/fungi.tre
    &&
#end if    
#if $ref_dir.selector == "custom"
    mkdir -p custom/
    &&
    ln -s '$ref_dir.custom_fna' custom/custom.fna
    &&
    ln -s '$ref_dir.custom_hmm' custom/custom.hmm
    &&
#if $placement_tool == "epa-ng"
    ln -s '$ref_dir.custom_model' custom/custom.model
#else if $placement_tool == "sepp"
    ln -s '$ref_dir.custom_model' custom/custom.raxml_info
#end if
    &&
    ln -s '$ref_dir.custom_tre' custom/custom.tre
    &&
#end if
place_seqs.py
    --study_fasta '$study_fasta'
    --placement_tool '$placement_tool'
#if $ref_dir.selector == "custom"
    --ref_dir custom
#else if $ref_dir.selector == "fungi"
    --ref_dir fungi
#end if
    --out_tree '$out_tree'
    --processes "\${GALAXY_SLOTS:-1}"
#if $intermediate_check
    --intermediate 'intermediate_out'
#end if
    --min_align $min_align
#if $chunk_size    
    --chunk_size $chunk_size
#end if   
    ]]></command>
    <inputs>
        <param argument="--study_fasta" type="data" format="fasta" label="Study sequences" help="The study sequences referred to are the representative OTUs and/or ASVs. The input study sequences need to be on the positive strand! "/>
        <param argument="--placement_tool" type="select" label="Placement tool to use when placing sequences into reference tree">
            <option value="epa-ng" selected="true">EPA-ng -  Fast, parallel, highly accurate Maximum Likelihood Phylogenetic Placement, by the team behind RAxML(-ng)</option>
            <option value="sepp">SEPP - SATe-enabled Phylogenetic Placement</option>
        </param>
        <conditional name="ref_dir">
            <param name="selector" type="select" label="Reference to use for sequence placement">
                <option value="prokaryotic" selected="true">Default: Prokaryotic 16S rRNA gene</option>
                <option value="fungi">Direct to the fungal ITS files</option>
                <option value="custom">Custom reference sequence files</option>
            </param>
            <when value="prokaryotic">
            </when>
            <when value="fungi">
                <param name="fungi_fna" type="data" format="fasta" label="Fasta file for the reference database of the sequesnces"/>
                <param name="fungi_hmm" type="data" format="hmm2,hmm3" label="HMM file for the reference database of the sequesnces"/>
                <param name="fungi_tre" type="data" format="newick" label="Tree file for the reference database of the sequesnces"/>
                <param name="fungi_model" type="data" format="txt" label="Modelfile for the reference database of the sequesnces"/>
            </when>
            <when value="custom">
                <param name="custom_fna" type="data" format="fasta,fasta.gz" label="Multiple-sequence alignment of reference sequences"/>
                <param name="custom_hmm" type="data" format="hmm2,hmm3" label="Hidden-markov model of the multiple-sequence alignment" help="The HMM of the alignment can be created using hmmbuild"/>
                <param name="custom_tre" type="data" format="newick" label="Tree of the reference sequences"/>
                <param name="custom_model" type="data" format="txt" label="Modelfile output by RaXmL specifying the best parameters for the tree"/>
            </when>
        </conditional>
        <param argument="--min_align" type="float" value="0.80" min="0.0" max="1.0" label="Proportion of the total length of an input query sequence that must align with reference sequences" help="Any sequences with lengths below this value after making an alignment with reference sequences will be excluded from the placement and all subsequent steps."/>
        <param argument="--chunk_size" type="integer" value="5000" optional="true" label="Number of query seqs to read in at once for EPA-ng"/>
        <param argument="--intermediate_check" type="boolean" truevalue="intermediate_check" falsevalue="" checked="false" label="Keep intermediate files?" help="Intermediate output files will be deleted by default"/>
   </inputs>
   <outputs>
        <data name="out_tree" format="newick" from_work_dir="out_tree.tre">
        </data>
        <collection name="intermediate_output_files" type="list" label="${tool.name} on ${on_string}: Intermediate files" >
            <discover_datasets pattern="(?P&lt;designation&gt;.+)" directory="intermediate_out/" format="fasta,tabular,stockholm"/>
            <filter>intermediate_check is True</filter>
        </collection>
    </outputs>
    <tests>
    <test expect_num_outputs="2">
        <param name="study_fasta" ftype="fasta" value="study_seqs_test.fasta"/>
        <param name="placement_tool" value="sepp"/>
        <param name="intermediate_check" value="true"/>
        <param name="min_align" value="0.80"/>
        <param name="chunk_size" value="5000"/>
        <conditional name="ref_dir">
            <param name="selector" value="prokaryotic"/>
        </conditional>
        <output name="out_tree" ftype="newick">
            <assert_contents>
                <has_text text="643348582"/>
                <has_n_lines n="1"/>
            </assert_contents>
        </output>
        <output_collection name="intermediate_output_files" type="list">
            <element name="query_align.stockholm">
                <assert_contents>
                    <has_text text="STOCKHOLM 1.0"/>
                    <has_n_lines n="160106"/>                
                </assert_contents>
            </element>
            <element name="study_seqs_filtered.fasta">
                <assert_contents>
                    <has_text text="02905cfb87861c837dde629596d9272b"/>
                    <has_n_lines n="10"/>  
                </assert_contents>
            </element>                                                                    
        </output_collection>
    </test>
    <test expect_num_outputs="1">
        <param name="study_fasta" value="study_seqs_test2.fasta"/>
        <param name="placement_tool" value="epa-ng"/>
        <param name="min_align" value="0.80"/>
        <param name="chunk_size" value="5000"/>
        <param name="intermediate_check" value="false"/>
        <conditional name="ref_dir">
            <param name="selector" value="fungi"/>
            <param name="fungi_fna" value="img_centroid_16S_aligned_head30.fna.gz"/>
            <param name="fungi_hmm" value="img_centroid_16S_aligned_head30.hmm"/>
            <param name="fungi_tre" value="img_centroid_16S_aligned_head30.tre"/>
            <param name="fungi_model" value="img_centroid_16S_aligned_head30.model"/>
        </conditional>
        <output name="out_tree" ftype="newick">
            <assert_contents>
                <has_text text="2511231175_test"/>
                <has_n_lines n="1"/>
            </assert_contents>
        </output>
    </test>
    </tests>
    <help><![CDATA[
@HELP_HEADER@

Place Seqs (Sequence placement)
===============================
PICRUSt2 wraps HMMER to place study sequences into a reference multiple-sequence alignment and then places these sequences into the reference phylogeny with EPA-NG or SEPP. The "study sequences" referred to will be the representative OTUs and/or ASVs under the typical workflow. The tool GAPPA is used to convert the resulting .jplace object into newick format.

Note
====
This is typically done to prep for subsequent hidden-state prediction with PICRUSt2. Requires unaligned FASTA of study sequences. Users can specify a non-default reference files if needed.

Input
=====
The study sequences (i.e. FASTA of amplicon sequence variants or operational taxonomic units)

Output
======
Output tree with placed study sequences.

    ]]></help> 
    <citations>
        <citation type="doi">10.1038/s41587-020-0548-6</citation>
    </citations>
 </tool>