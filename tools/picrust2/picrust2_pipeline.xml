<tool id="picrust2_pipeline" name="PICRUSt2 Full pipeline" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description></description>
    <expand macro="bio_tool"/>    
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <version_command>picrust2_pipeline.py -v</version_command>
    <command detect_errors="exit_code"><![CDATA[
#if $input.datatype.file_ext == "mothur.shared"
    #set ext="msf"
#else if $input.datatype.file_ext == "tabular"
    #set ext="tsv"
#else if $input.ext == 'biom2'
    #set ext="biom"
#else if $input.ext == 'biom1'
    #set ext="biom"
#else
    >&2 "unknown extension $input.ext"
    exit 1;
#end if
#if $input.ext.endswith(".gz")
    #set ext+=".gz"
#end if
ln -s '$input' 'input.$ext' &&
#if $ref_dir.selector == "fungi"
    mkdir -p fungi/
    &&
    ln -s '$ref_dir.fungi_fna' fungi/fungi.fna
    &&
    ln -s '$ref_dir.fungi_hmm' fungi/fungi.hmm
    &&
#if $placement_tool == "epa-ng"
    ln -s '$ref_dir.fungi_model' fungi/fungi.model
#else if $placement_tool == "sepp"
    ln -s '$ref_dir.fungi_model' fungi/fungi.raxml_info
#end if
    &&
    ln -s '$ref_dir.fungi_tre' fungi/fungi.tre
    &&
#end if    
#if $ref_dir.selector == "custom"
    mkdir -p custom/
    &&
    ln -s '$ref_dir.custom_fna' custom/custom.fna
    &&
    ln -s '$ref_dir.custom_hmm' custom/custom.hmm
    &&
#if $placement_tool == "epa-ng"
    ln -s '$ref_dir.custom_model' custom/custom.model
#else if $placement_tool == "sepp"
    ln -s '$ref_dir.custom_model' custom/custom.raxml_info
#end if
    &&
    ln -s '$ref_dir.custom_tre' custom/custom.tre
    &&
#end if
picrust2_pipeline.py
    --study_fasta '$study_fasta'
    --input 'input.$ext'
#if $input_options.selector == "ASV"
    --min_reads $input_options.min_reads
    --min_samples $input_options.min_samples
#end if
    --placement_tool '$placement_tool'
#if $ref_dir.selector == "custom"
    --ref_dir custom
#else if $ref_dir.selector == "fungi"
    --ref_dir fungi
#end if
#if $trait_input.selector == "default"
    --in_traits '$trait_input.in_traits'
#else if $trait_input.selector == "custom"
    --custom_trait_tables '$trait_input.custom_trait_tables'
    --marker_gene_table '$trait_input.marker_gene_table'
#end if
#if $pathway_map_file.selector == "custom"
    --pathway_map '$pathway_map_file.pathway_map'
#end if
#if $infer_pathway.selector == "yes"
#if $infer_pathway.reaction_map_file.selector == "default"
    $infer_pathway.reaction_map_file.no_pathways
    --reaction_func '$infer_pathway.reaction_map_file.reaction_func'
#else if $infer_pathway.reaction_map_file.selector == "custom"
    $infer_pathway.reaction_map_file.no_pathways
    --reaction_func '$infer_pathway.reaction_map_file.reaction_func'
#end if
#else if $infer_pathway.selector == "no"
    $infer_pathway.no_pathways
#end if
#if $regrouping.selector == "yes"
#if $regrouping.map_file_regroup.selector == "default"
    $regrouping.map_file_regroup.no_regroup
#else if $regrouping.map_file_regroup.selector == "custom"
    $regrouping.map_file_regroup.no_regroup
    --regroup_map '$regrouping.map_file_regroup.regroup_map'
#end if
#else if $regrouping.selector == "no"
    $regrouping.no_regroup
#end if
#if $stratified_output.selector == 'yes'
    $stratified_output.stratified
    $stratified_output.wide_table
#end if
    --hsp_method '$hsp_method__options.hsp_method'
#if $hsp_method__options.hsp_method == "mp"
    --edge_exponent $hsp_method__options.edge_exponent
#end if
    --min_align $min_align
    $skip_nsti
    --max_nsti $max_nsti
    $skip_minpath
    $skip_norm
    $no_gap_fill
#if $coverage_output.selector == 'yes'
    $coverage_output.coverage
    $coverage_output.per_sequence_contrib
#end if
    $remove_intermediate
    --output 'full_pipeline_output'
    --processes "\${GALAXY_SLOTS:-1}"
    ]]></command>
    <inputs>
        <param argument="--study_fasta" type="data" format="fasta" label="Study sequences" help="The study sequences referred to are the representative OTUs and/or ASVs. The input study sequences need to be on the positive strand! "/>
        <param argument="--input" type="data" format="tabular,biom1,biom2,mothur.shared" label="Sequence abundance table (OTUs or ASVs)" help="The sequence abundances should be in read counts and not relative abundances. The tool will normalize the input sequence abundance table by the predicted number of marker genes."/>
        <conditional name="input_options">
            <param name="selector" type="select" label="Sequence abundance table type">
                <option value="OTU" selected="true">Operational Taxonomic Units (OTU)</option>
                <option value="ASV">Amplicon Sequence Variants (ASV)</option>
            </param>
            <when value="OTU">
            </when>
            <when value="ASV">
                <param argument="--min_reads" type="integer" value="1" label="Minimum number of reads across all samples for each input ASV." help="ASVs below this cut-off will be counted as part of the RARE category in the stratified output"/>
                <param argument="--min_samples" type="integer" value="1" label="Minimum number of samples that an ASV needs to be identfied within" help="ASVs below this cut-off will be counted as part of the RARE category in the stratified output"/>
            </when>
        </conditional>
        <param argument="--placement_tool" type="select" label="Placement tool to use when placing sequences into reference tree">
            <option value="epa-ng" selected="true">EPA-ng -  Fast, parallel, highly accurate Maximum Likelihood Phylogenetic Placement, by the team behind RAxML(-ng)</option>
            <option value="sepp">SEPP - SATe-enabled Phylogenetic Placement</option>
        </param>
        <conditional name="ref_dir">
            <param name="selector" type="select" label="Reference to use for sequence placement">
                <option value="prokaryotic" selected="true">Default: Prokaryotic 16S rRNA gene</option>
                <option value="fungi">Direct to the fungal ITS files</option>
                <option value="custom">Custom reference sequence files</option>
            </param>
            <when value="prokaryotic">
            </when>
            <when value="fungi">
                <param name="fungi_fna" type="data" format="fasta" label="Fasta file for the reference database of the sequesnces"/>
                <param name="fungi_hmm" type="data" format="hmm2,hmm3" label="HMM file for the reference database of the sequesnces"/>
                <param name="fungi_tre" type="data" format="newick" label="Tree file for the reference database of the sequesnces"/>
                <param name="fungi_model" type="data" format="txt" label="Modelfile for the reference database of the sequesnces"/>
            </when>
            <when value="custom">
                <param name="custom_fna" type="data" format="fasta,fasta.gz" label="Multiple-sequence alignment of reference sequences"/>
                <param name="custom_hmm" type="data" format="hmm2,hmm3" label="Hidden-markov model of the multiple-sequence alignment" help="The HMM of the alignment can be created using hmmbuild"/>
                <param name="custom_tre" type="data" format="newick" label="Tree of the reference sequences"/>
                <param name="custom_model" type="data" format="txt" label="Modelfile output by RaXmL specifying the best parameters for the tree"/>
            </when>
        </conditional>
        <conditional name="trait_input">
            <param name="selector" type="select" label="Argument specifying non-default reference files to use for sequence placement">
                <option value="default" selected="true">Default trait table</option>
                <option value="custom">Customized trait table</option>
            </param>
            <when value="default">
                <param argument="--in_traits" type="select" multiple="true" label="Default pre-calculated count table to use">
                    <option value="16S">16S</option>
                    <option value="COG">COG</option>
                    <option value="EC" selected="true">EC</option>
                    <option value="KO" selected="true">KO</option>
                    <option value="PFAM">PFAM</option>
                    <option value="TIGRFAM">TIGRFAM</option>
                    <option value="PHENO">PHENO</option>
                </param>
            </when>
            <when value="custom">
                <param argument="--custom_trait_tables" type="data" multiple="true" format="tabular" label="Customized trait table(s)" help="with gene families as columns and genomes as rows"/>
                <param argument="--marker_gene_table" type="data" format="tabular" optional="true" label="Table of predicted marker gene (16S or other) copy numbers" />            
            </when>
        </conditional>
        <conditional name="pathway_map_file">
            <param name="selector" type="select" label="Minimum pathway mapping file">
                <option value="default" selected="true">Default mapping file (Maps MetaCyc reactions to prokaryotic MetaCyc pathways)</option>
                <option value="custom">Customized mapping file</option>
            </param>
            <when value="default">
            </when>
            <when value="custom">
                <param argument="--pathway_map" type="data" format="txt,tabular" label="Customized table mapping of pathways to reactions"/>
            </when>
        </conditional>
        <conditional name="infer_pathway">
            <param name="selector" type="select" label="Do you want to infer the pathways">
                <option value="yes" selected="true">Yes</option>
                <option value="no">No</option>
            </param>
            <when value="yes">
                <conditional name="reaction_map_file">
                    <param name="selector" type="select" label="Functional database to use as reactions for inferring pathway abundances">
                        <option value="default" selected="true">Default functional database</option>
                        <option value="custom">Customized reation functional map file</option>
                    </param>
                    <when value="default">
                        <param argument="--no_pathways" type="boolean" truevalue="" falsevalue="--no_pathways" checked="true" label="Infer pathways?"/> 
                        <param argument="--reaction_func" type="select" label="Default functional database">
                            <option value="METACYC">Metabolic Pathway database (MetaCyc)</option>
                            <option value="COG">Clusters of Orthologous Genes database (COG)</option>
                            <option value="EC" selected="true">Enzyme Commission number database (EC number)</option>
                            <option value="KO">KEGG Orthology database (KO)</option>
                            <option value="PFAM">Pfam database</option>
                            <option value="TIGRFAM">TIGRFAM database</option>
                        </param>
                    </when>
                    <when value="custom">
                        <param argument="--no_pathways" type="boolean" truevalue="" falsevalue="--no_pathways" checked="true" label="Infer pathways?"/>
                        <param argument="--reaction_func" type="data" format="tabular" label="Custom mapping table" help="An input 2 column map table linking function ids to descriptions for each function"/>
                    </when>
                </conditional>
            </when>
            <when value="no">
                <param argument="--no_pathways" type="boolean" truevalue="" falsevalue="--no_pathways" checked="false" label="Infer pathways?"/> 
            </when>
        </conditional>
        <conditional name="regrouping">
            <param name="selector" type="select" label="Do you want to regroup input gene families to reactions as specified in the regrouping mapfile?">
                <option value="yes" selected="true">Yes</option>
                <option value="no">No</option>
            </param>
            <when value="yes">
                <conditional name="map_file_regroup">
                    <param name="selector" type="select" label="Mapping file to regroup gene families to reactions">
                        <option value="default" selected="true">Default mapping file (is for regrouping EC numbers to MetaCyc reactions)</option>
                        <option value="custom">Customized mapping file</option>
                    </param>
                <when value="default">
                    <param argument="--no_regroup" type="boolean" truevalue="" falsevalue="--no_regroup" checked="true" label="Regroup input gene families to reactions as specified in the regrouping mapfile"/> 
                </when>
                <when value="custom">
                    <param argument="--no_regroup" type="boolean" truevalue="" falsevalue="--no_regroup" checked="true" label="Regroup input gene families to reactions as specified in the regrouping mapfile"/> 
                    <param argument="--regroup_map" type="data" format="tabular" label="Mapfile of ids to regroup gene families to before running MinPath"/>
                </when>
                </conditional> 
            </when>
            <when value="no">
                <param argument="--no_regroup" type="boolean" truevalue="" falsevalue="--no_regroup" checked="false" label="Regroup input gene families to reactions as specified in the regrouping mapfile"/> 
            </when>
        </conditional>
        <conditional name="stratified_output">
            <param name="selector" type="select" label="Generate an output table stratified by sequences?">
                <option value="no" selected="true">No</option>
                <option value="yes">Yes [will increase run-time]</option>
            </param>
            <when value="yes">
                <param argument="--stratified" type="boolean" truevalue="--stratified" falsevalue="" checked="true" label="Generate an output table stratified by sequences?"/> 
                <param argument="--wide_table" type="boolean" truevalue="--wide_table" falsevalue="" checked="false" label="Flag to specify that wide-format stratified table should be output rather than metagenome contribution table"/>             
            </when>
            <when value="no">
                <param argument="--stratified" type="boolean" truevalue="--stratified" falsevalue="" checked="false" label="Generate an output table stratified by sequences?"/> 
            </when>            
        </conditional>
        <conditional name="hsp_method__options">
            <param argument="--hsp_method" type="select" label="Hidden-state prediction method to use">
                <option value="mp" selected="true">Predict discrete traits by: Maximum parsimony (mp)</option>
                <option value="emp_prob">Predict discrete traits by: Empirical state probabilities across tips (emp_prob)</option>
                <option value="subtree_average">Predict continuous traits by: Subtree averaging (subtree_average)</option>
                <option value="pic">Predict continuous traits by: phylogentic independent contrast (pic)</option>
                <option value="scp">Reconstruct continuous traits by: squared-change parsimony (scp)</option>
            </param>
            <when value="mp">
                <param argument="--edge_exponent" type="float" value="0.5" min="0.0" label="Setting for maximum parisimony hidden-state prediction" help="Specifies weighting transition costs by the inverse length of edge lengths. If 0, then edge lengths do not influence predictions"/>
            </when>
            <when value="emp_prob">
            </when>
            <when value="subtree_average">
            </when>
            <when value="pic">
            </when>
            <when value="scp">
            </when>
        </conditional>
        <param argument="--min_align" type="float" value="0.0" min="0.0" max="1.0" label="Proportion of the total length of an input query sequence that must align with reference sequences" help="Any sequences with lengths below this value after making an alignment with reference sequences will be excluded from the placement and all subsequent steps."/>
        <param argument="--skip_nsti" type="boolean" truevalue="" falsevalue="--skip_nsti" checked="false" label="Calculate nearest-sequenced taxon index (NSTI)?"/>         
        <param argument="--max_nsti" type="float" value="2.0" label="Sequences with Nearest-sequenced taxon index (NSTI) values above this value will be excluded"/>        
        <param argument="--skip_minpath" type="boolean" truevalue="" falsevalue="--skip_minpath" checked="false" label="Run MinPath to identify which pathways are present as a first pass?"/> 
        <param argument="--skip_norm" type="boolean" truevalue="--skip_norm" falsevalue="" checked="false" label="Skip normalizing sequence abundances by predicted marker gene copy numbers"/> 
        <param argument="--no_gap_fill" type="boolean" truevalue="" falsevalue="--no_gap_fill" checked="true" label="Perform gap filling before predicting pathway abundances?"/> 
        <conditional name="coverage_output">
            <param name="selector" type="select" label="Calculate pathway coverages as well as abundance?">
                <option value="yes">Yes [experimental and only useful for advanced users]</option>
                <option value="no" selected="true">No</option>
            </param>
            <when value="yes">
                <param argument="--coverage" type="boolean" truevalue="--coverage" falsevalue="" checked="true" label="Calculate pathway coverages as well as abundances"/> 
                <param argument="--per_sequence_contrib" type="boolean" truevalue="--per_sequence_contrib" falsevalue="" checked="true" label="Per sequence contrib: flag to specify that MinPath is run on the genes contributed by each sequence individually"/>            
            </when>
            <when value="no">
                <param argument="--coverage" type="boolean" truevalue="--coverage" falsevalue="" checked="false" label="Calculate pathway coverages as well as abundances"/> 
                <param argument="--per_sequence_contrib" type="boolean" truevalue="--per_sequence_contrib" falsevalue="" checked="false" label="Per sequence contrib: flag to specify that MinPath is run on the genes contributed by each sequence individually"/> 
            </when>
        </conditional>
        <param argument="--remove_intermediate" type="boolean" truevalue="" falsevalue="--remove_intermediate" checked="false" label="Keep intermediate files?" help="If turned off the tool will remove the intermediate outfiles of the sequence placement and pathway inference steps"/>
    </inputs>
    <outputs>
        <data name="out_tree" format="newick" from_work_dir="full_pipeline_output/out.tre">
        </data>
        <collection name="full_pipeline_output_files" type="list" label="${tool.name} on ${on_string}: PICRUSt2 Output" >
            <discover_datasets pattern="(?P&lt;designation&gt;.+)" directory="full_pipeline_output/" format="tabular"/>
        </collection>
        <collection name="intermediate_output_files" type="list" label="${tool.name} on ${on_string}: Intermediate files" >
            <discover_datasets pattern="(?P&lt;designation&gt;.+)" directory="full_pipeline_output/intermediate/place_seqs" format="fasta,tabular,stockholm"/>
            <filter>remove_intermediate is True</filter>
        </collection>
    </outputs>
    <tests>

    </tests>
    <help><![CDATA[
@HELP_HEADER@

PICRUSt2 full pipeline
======================
Run sequence placement with EPA-NG and GAPPA to place study sequences (i.e. OTUs and ASVs) into a reference tree. Then runs hidden-state prediction with the castor R package to predict genome for each study sequence. Metagenome profiles are then generated, which can be optionally stratified by the contributing sequence. Finally, pathway abundances are predicted based on metagenome profiles. By default, output files include predictions for Enzyme Commission (EC) numbers, KEGG Orthologs (KOs), and MetaCyc pathway abundances. However, the tool enables users to use custom reference and trait tables to customize analyses.

Input
=====

Output
======

    ]]></help> 
    <citations>
        <citation type="doi">10.1038/s41587-020-0548-6</citation>
    </citations>
 </tool>