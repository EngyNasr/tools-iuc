<tool id="instrain_profile" name="Profile" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>InStrain is a tool for analysis of co-occurring genome populations from metagenomes, Profile: creates an inStrain profile (microdiversity analysis) from a mapping file </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="edam_ontology"/>
    <expand macro="requirements"/>
    <version_command>inStrain profile --version</version_command>
    <command detect_errors="exit_code"><![CDATA[
#set ext=$mapping_input.datatype.file_ext
cp '$mapping_input' 'inputbam.$ext'
#if $gene_profiling.gene_file
&&
cp '$gene_profiling.gene_file' 'gene_file.fna'
#end if
#if $stb
&&
cp '$stb' 'stb_file.stb'
#end if
&&
inStrain profile
    'inputbam.$ext'
    '$sequence_input'
    --output 'inStrain.IS'
    $use_full_fasta_header
    --processes "\${GALAXY_SLOTS:-6}"
    --min_mapq $read_filtering.min_mapq
    --max_insert_relative $read_filtering.max_insert_relative
    --min_insert $read_filtering.min_insert
    --pairing_filter '$read_filtering.pairing_filter'
#if $priority_reads
    --priority_reads '$read_filtering.priority_reads'
#end if
    $output.detailed_mapping_info
    --min_cov $variant_calling.min_cov
    --min_freq $variant_calling.min_freq
    --fdr $variant_calling.fdr
#if $gene_file
    --gene_file 'gene_file.fna'
#end if
#if $stb
    --stb 'stb_file.stb'
#end if    
    $mm_level
#if $profile.database_mode
    $profile.database_mode
#else
    --min_read_ani $read_filtering.min_read_ani
    --min_genome_coverage $profile.min_genome_coverage
    $skip_mm_profiling
#end if
    --min_scaffold_reads $profile.min_scaffold_reads
    --min_snp $profile.min_snp
    $profile.store_everything
#if $profile.scaffolds_to_profile
    --scaffolds_to_profile '$profile.scaffolds_to_profile'
#end if
    --rarefied_coverage $profile.rarefied_coverage
    --window_length $profile.window_length
    $output.skip_genome_wide
    $output.skip_plot_generation
    ]]></command>
    <inputs>
        <param name="mapping_input" type="data" format="bam,sam" label="A file containing metagenomic reads mapped to a DNA sequence" help="Sorted Bam file"/>
        <param name="sequence_input" type="data" format="fasta" label="A file containing a DNA sequence."/>
        <param argument="--use_full_fasta_header" type="boolean" truevalue="--use_full_fasta_header" falsevalue="" checked="false" label="Use full fasta header" help="Instead of using the fasta ID (space in header before space), use the full header. Needed for some mapping tools (including bbMap)"/>
        <section name="read_filtering" title="Read Filtering" expanded="true">
            <param argument="--min_read_ani" type="float" value="0.95" min="0" max="1" label="Minimum percent identity" help=" Minimum percent identity of read pairs to consensus to use the reads. Must be >, not >="/>
            <param argument="--min_mapq" type="integer" value="-1" label="Minimum mapq score" help="Minimum mapq score of EITHER read in a pair to use that pair. Must be >, not >="/>
            <param argument="--max_insert_relative" type="integer" value="3" label="Maximum insert relative" help="Multiplier to determine maximum insert size between two reads - default is to use 3x median insert size. Must be >, not >="/>
            <param argument="--min_insert" type="integer" value="50" label="Minimum insert" help="Minimum insert size between two reads - default is 50 bp. If two reads are 50bp each and overlap completely, their insert will be 50. Must be >, not >="/>
            <param argument="--pairing_filter" type="select" label="How should paired reads be handled?">
                <option value="paired_only" selected="true">Only paired reads are retained</option>
                <option value="non_discordant">Keep all paired reads and singleton reads that map to a single scaffold</option>
                <option value="all_reads">Keep all reads regardless of pairing status (NOT RECOMMENDED; See documentation for deatils)</option>
            </param>
            <param argument="--priority_reads" type="data" format="fastqsanger,fastqsanger.gz" optional="true" label="The location of a list of reads that should be retained regardless of pairing status" help="For example long reads or merged reads. This can be a .fastq file or text file with list of read names (will assume file is compressed if ends in .gz"/>
        </section>
        <section name="variant_calling" title="Variant Calling" expanded="true">
            <param argument="--min_cov" type="integer" value="5" label="Minimum coverage" help=" Minimum coverage to call a variant"/>
            <param argument="--min_freq" type="float" value="0.05" label="Minimum SNP frequency" help="Minimum SNP frequency to confirm a SNV (both this AND the FDR snp count cutoff must be true to call a SNP)."/>
            <param argument="--fdr" type="float" value="1e-06" min="0" max="1" label="FDR" help="SNP false discovery rate- based on simulation data with a 0.1 percent error rate (Q30)"/>
        </section>
        <section name="gene_profiling" title="Gene Profiling" expanded="true">
            <param argument="--gene_file" type="data" format="fasta,genbank" optional="true" label="Path to prodigal .fna genes file. If file ends in .gb or .gbk, will treat as a genbank file" help="EXPERIMENTAL; the name of the gene must be in the gene qualifier"/>
        </section>
        <param argument="--stb" type="data" format="tabular" optional="true" label="Scaffold to bin" help="This can be a file with each line listing a scaffold and a bin name, tab-seperated. This can also be a space-seperated list of .fasta files, with one genome per .fasta file. If nothing is provided, all scaffolds will be treated as belonging to the same genome"/>
        <param argument="--mm_level" type="boolean" truevalue="--mm_level" falsevalue="" checked="false" label="Create output files on the mm level"/>
        <param argument="--skip_mm_profiling" type="boolean" truevalue="--skip_mm_profiling" falsevalue="" checked="false" label ="Skip mm profiling" help="Dont perform analysis on an mm level; saves RAM and time; impacts plots and raw_data"/>
        <section name="profile" title="Profile" expanded="true">
            <param argument="--database_mode" type="boolean" truevalue="--database_mode" falsevalue="" checked="false" label="Database mode" help="Set a number of parameters to values appropriate for mapping to a large fasta file."/>
            <param argument="--min_scaffold_reads" type="integer" value="1" label="Minimum scaffold reads" help="Minimum number of reads mapping to a scaffold to proceed with profiling it"/>
            <param argument="--min_genome_coverage" type="integer" value="0" label="Minimum genome coverage" help="Minimum number of reads mapping to a genome to proceed with profiling it. MUST profile .stb if this is set"/>
            <param argument="--min_snp" type="integer" value="20" label="Minimum SNP" help="Absolute minimum number of reads connecting two SNPs to calculate LD between them."/>
            <param argument="--store_everything" type="boolean" truevalue="--store_everything" falsevalue="" checked="false" label="Store everything" help="Store intermediate dictionaries in the pickle file; will result in significantly more RAM and disk usage"/>
            <param argument="--scaffolds_to_profile" type="data" format="fasta" optional="true" label="Scaffolds to profile" help="File containing a list of scaffolds to profile- if provided will ONLY profile those scaffolds"/>
            <param argument="--rarefied_coverage" type="integer" value="50" label="Rarefied coverage" help="When calculating nucleotide diversity, also calculate a rarefied version with this much coverage"/>
            <param argument="--window_length" type="integer" value="10000" label ="Window length" help="Break scaffolds into windows of this length when profiling"/>
        </section>
        <section name="output" title="Set Output Parameters" expanded="true">
            <param argument="--detailed_mapping_info" type="boolean" truevalue="--detailed_mapping_info" falsevalue="" checked="false" label="Detailed mapping info" help="Make a detailed read report indicating deatils about each individual mapped read"/>
            <param argument="--skip_genome_wide" type="boolean" truevalue="--skip_genome_wide" falsevalue="" checked="false" label="Skip genome wide" help="Do not generate tables that consider groups of scaffolds belonging to genomes"/>
            <param argument="--skip_plot_generation" type="boolean" truevalue="--skip_plot_generation" falsevalue="" checked="false" label="Skip plot generation" help="Do not make plots"/>
        </section>
    </inputs>
    <outputs>  
        <data name="scaffold_info" format="tabular" from_work_dir="inStrain.IS/output/inStrain.IS_scaffold_info.tsv" label="Scoffold Info, This gives basic information about the scaffolds in your sample at the highest allowed level of read identity." >
        </data>
        <data name="mapping_info" format="tabular" from_work_dir="inStrain.IS/output/inStrain.IS_mapping_info.tsv" label="Mapping Info, This provides an overview of the number of reads that map to each scaffold, and some basic metrics about their quality." >
        </data>
        <data name="SNVs" format="tabular" from_work_dir="inStrain.IS/output/inStrain.IS_SNVs.tsv" label="SNV, This describes the SNVs and SNSs that are detected in this mapping." >
        </data>
        <data format="tabular" name="linkage" from_work_dir="inStrain.IS/output/inStrain.IS_linkage.tsv" label="Linkage, This describes the linkage between pairs of SNPs in the mapping that are found on the same read pair at least min_snp times." >
        </data>
        <data format="tabular" name="gene_info" from_work_dir="inStrain.IS/output/inStrain.IS_gene_info.tsv" label="Gene Info, This describes some basic information about the genes being profiled" >
        </data> 
        <data format="tabular" name="genome_info" from_work_dir="inStrain.IS/output/inStrain.IS_genome_info.tsv" label="Genome Info, This Describes many of the above metrics on a genome-by-genome level, rather than a scaffold-by-scaffold level." >
            <filter>(output['skip_genome_wide'] is False)</filter>
        </data>
        <data format="pdf" name="CoverageAndBreadth_vs_readMismatch" from_work_dir="inStrain.IS/figures/inStrain.IS_CoverageAndBreadth_vs_readMismatch.pdf" label="CoverageAndBreadth vs readMismatch" >
            <filter>(output['skip_plot_generation'] is False)</filter>
        </data>
        <data format="pdf" name="GeneHistogram_plot" from_work_dir="inStrain.IS/figures/inStrain.IS_GeneHistogram_plot.pdf" label="GeneHistogram plot" >
            <filter>(output['skip_plot_generation'] is False)</filter>
        </data>
        <data format="pdf" name="LinkageDecay_types_plot" from_work_dir="inStrain.IS/figures/inStrain.IS_LinkageDecay_types_plot.pdf" label="LinkageDecay types plot" >
            <filter>(output['skip_plot_generation'] is False)</filter>        
        </data>
        <data format="pdf" name="ScaffoldInspection_plot" from_work_dir="inStain/.ISfigures/inStrain.IS_ScaffoldInspection_plot.pdf" label="ScaffoldInspection plot" >
            <filter>(output['skip_plot_generation']is False)</filter>        
        </data>
        <data format="pdf" name="ReadFiltering_plot" from_work_dir="inStrain.IS/figures/inStrain.IS_ReadFiltering_plot.pdf" label="ReadFiltering plot" >
            <filter>(output['skip_plot_generation'] is False)</filter>
        </data>
        <data format="pdf" name="LinkageDecay_plot" from_work_dir="inStrain.IS/figures/inStrain.IS_LinkageDecay_plot.pdf" label="LinkageDecay plot" >
            <filter>(output['skip_plot_generation']is False)</filter>
        </data>
        <data format="pdf" name="MajorAllele_frequency_plot" from_work_dir="inStrain.IS/figures/inStrain.IS_MajorAllele_frequency_plot.pdf" label="MajorAllele frequency plot" >
            <filter>(output['skip_plot_generation'] is False)</filter>       
        </data>
        <data format="pdf" name="readANI_distribution" from_work_dir="inStrain.IS/figures/inStrain.IS_readANI_distribution.pdf" label="readANI distribution" >
            <filter>(output['skip_plot_generation'] is False)</filter>        
        </data>
        <data format="pdf" name="genomeWide_microdiveristy_metrics" from_work_dir="inStrain.IS/figures/inStrain.IS_genomeWide_microdiveristy_metrics.pdf" label="genomeWide microdiveristy metrics" >
            <filter>(output['skip_plot_generation'] is False)</filter>       
        </data>
    </outputs>
    <tests>
    <test expect_num_outputs="5">
        <!--TODO: auto-generated test case. Please fill in the required values-->
        <param name="mapping_input" value="N5_271_010G1_scaffold_min1000.fa-vs-N5_271_010G1.sam"/>
        <param name="sequence_input" value="N5_271_010G1_scaffold_min1000.fa"/>
        <param name="use_full_fasta_header" value="false"/>
        <param name="stb" value="N5_271_010G1.maxbin2.stb"/>
        <param name="mm_level" value="false"/>
        <param name="skip_mm_profiling" value="false"/>
        <section name="read_filtering">
            <param name="min_read_ani" value="0.95"/>
            <param name="min_mapq" value="-1"/>
            <param name="max_insert_relative" value="3"/>
            <param name="min_insert" value="50"/>
            <param name="pairing_filter" value="paired_only"/>
        </section>
        <section name="variant_calling">
            <param name="min_cov" value="5"/>
            <param name="min_freq" value="0.05"/>
            <param name="fdr" value="1e-06"/>
        </section>
        <section name="gene_profiling">
            <param name="gene_file" value="N5_271_010G1_scaffold_min1000.fa.genes.fna"/>
        </section>
        <section name="profile">
            <param name="database_mode" value="false"/>
            <param name="min_scaffold_reads" value="1"/>
            <param name="min_genome_coverage" value="0"/>
            <param name="min_snp" value="20"/>
            <param name="store_everything" value="false"/>
            <param name="rarefied_coverage" value="50"/>
            <param name="window_length" value="10000"/>
        </section>
        <section name="output">
            <param name="detailed_mapping_info" value="false"/>
            <param name="skip_genome_wide" value="true"/>
            <param name="skip_plot_generation" value="true"/>
        </section>
        <output name="scaffold_info">
            <assert_contents>
                <has_text text="length"/>
                <has_line line="179"/>
                <has_n_columns n="21"/>
            </assert_contents>
        </output>
        <output name="mapping_info">
            <assert_contents>
                <has_text text="scaffold"/>
                <has_line line="181"/>
                <has_n_columns n="19"/>
            </assert_contents>
        </output>
        <output name="SNVs">
            <assert_contents>
                <has_text text="position"/>
                <has_line line="1808"/>
                <has_n_columns n="19"/>
            </assert_contents>
        </output>
        <output name="linkage">
            <assert_contents>
                <has_text text="r2"/>
                <has_line line="3037"/>
                <has_n_columns n="17"/>
            </assert_contents>
        </output>
        <output name="gene_info">
            <assert_contents>
                <has_text text="coverage"/>
                <has_line line="802"/>
                <has_n_columns n="20"/>
            </assert_contents>
        </output>
    </test>
    </tests>
</tool>